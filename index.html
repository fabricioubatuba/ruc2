<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Ranking Ubatuba de Ciclismo - R.U.C.</title>

    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="https://raw.githubusercontent.com/fabricioubatuba/ruc2/refs/heads/main/assets/img/favicon.ico">

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- Firebase (v8) -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <!-- jQuery & mask -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.mask/1.14.16/jquery.mask.min.js"></script>

    <style>
        :root {
            --primary-color: #2196F3;
            --success-color: #4CAF50;
            --danger-color: #F44336;
            --warning-color: #FF9800;
            --dark-color: #2c3e50;
            --light-color: #f5f5f5;
            --text-color: #333;
            --text-light: #7f8c8d;
            --border-radius: 8px;
            --box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            --transition: all 0.3s ease;
        }
        * { margin:0; padding:0; box-sizing:border-box; }
        body {
            font-family: 'Poppins', sans-serif;
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            background-color: var(--light-color);
            color: var(--text-color);
            line-height: 1.6;
        }
        header { text-align:center; margin-bottom:40px; padding-bottom:30px; border-bottom:2px solid var(--dark-color); }
        .logo { display:block; width:180px; margin:0 auto 20px; }
        h1 { color:var(--dark-color); font-family:'Montserrat', sans-serif; font-weight:700; margin-bottom:10px; font-size:2.5rem; }
        .subtitle { color:var(--text-light); font-size:1.2em; font-weight:300; }

        .nav-tabs { display:flex; justify-content:center; margin-bottom:30px; border-bottom:1px solid #ddd; }
        .nav-tab { padding:12px 24px; background:none; border:none; font-family:'Poppins',sans-serif; font-size:1rem; font-weight:500; cursor:pointer; color:var(--text-light); border-bottom:3px solid transparent; transition:var(--transition); }
        .nav-tab.active { color:var(--primary-color); border-bottom-color:var(--primary-color); }
        .nav-tab:hover { color:var(--primary-color); }

        .races-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(300px,1fr)); gap:25px; margin-bottom:40px; }
        .race-card { background-color:white; border-radius:var(--border-radius); overflow:hidden; box-shadow:var(--box-shadow); transition:var(--transition); }
        .race-card:hover { transform:translateY(-5px); box-shadow:0 8px 20px rgba(0,0,0,0.15); }
        .race-image-container { width:100%; height:200px; overflow:hidden; display:flex; align-items:center; justify-content:center; background:#f0f0f0; }
        .race-image { width:100%; height:100%; object-fit:cover; transition:var(--transition); }
        .race-content { padding:20px; }
        .race-title { color:var(--dark-color); font-family:'Montserrat',sans-serif; font-weight:600; margin-bottom:10px; font-size:1.3rem; line-height:1.3; }
        .race-meta { display:flex; justify-content:space-between; margin-bottom:15px; font-size:0.9rem; }
        .race-date { color:var(--text-light); font-weight:500; }
        .race-price { color:var(--success-color); font-weight:600; }
        .race-status { display:inline-block; padding:5px 12px; border-radius:20px; font-weight:600; font-size:0.8rem; margin-bottom:15px; }
        .status-open { background-color:var(--success-color); color:white; }
        .status-closed { background-color:var(--danger-color); color:white; }
        .status-finished { background-color:var(--warning-color); color:white; }
        .race-description { color:var(--text-light); font-size:0.9rem; margin-bottom:20px; display:-webkit-box; -webkit-line-clamp:3; -webkit-box-orient:vertical; overflow:hidden; }

        .btn { padding:10px 16px; border:none; border-radius:var(--border-radius); color:white; font-family:'Poppins',sans-serif; font-weight:500; cursor:pointer; text-decoration:none; display:inline-flex; align-items:center; justify-content:center; transition:var(--transition); font-size:0.9rem; min-height:42px; width:100%; margin-bottom:8px; }
        .btn-primary { background-color:var(--primary-color); }
        .btn-primary:hover { background-color:#1976D2; }
        .btn-success { background-color:var(--success-color); }
        .btn-success:hover { background-color:#388E3C; }
        .btn-danger { background-color:var(--danger-color); }
        .btn-danger:hover { background-color:#D32F2F; }
        .btn-warning { background-color:var(--warning-color); }
        .btn-warning:hover { background-color:#F57C00; }
        .btn-small { padding:8px 12px; font-size:0.85rem; min-height:auto; }

        .modal { display:none; position:fixed; z-index:1000; left:0; top:0; width:100%; height:100%; overflow:auto; background-color:rgba(0,0,0,0.5); backdrop-filter:blur(5px); }
        .modal-content { background-color:#fefefe; margin:5% auto; padding:30px; border-radius:var(--border-radius); width:90%; max-width:700px; box-shadow:0 10px 30px rgba(0,0,0,0.2); position:relative; animation:modalFadeIn 0.3s ease; }
        @keyframes modalFadeIn { from { opacity:0; transform:translateY(-20px);} to { opacity:1; transform:translateY(0);} }
        .close { color:#aaa; position:absolute; top:15px; right:20px; font-size:28px; font-weight:bold; cursor:pointer; transition:var(--transition); }
        .close:hover { color:var(--danger-color); }
        .modal h2 { color:var(--dark-color); margin-bottom:20px; font-family:'Montserrat',sans-serif; font-weight:600; }

        .form-group { margin-bottom:20px; }
        .form-group label { display:block; margin-bottom:8px; font-weight:500; color:var(--dark-color); }
        .form-group input, .form-group select, .form-group textarea { width:100%; padding:12px; border:1px solid #ddd; border-radius:var(--border-radius); font-family:'Poppins',sans-serif; font-size:1rem; transition:var(--transition); }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus { outline:none; border-color:var(--primary-color); box-shadow:0 0 0 2px rgba(33,150,243,0.2); }
        .form-row { display:flex; gap:15px; }
        .form-row .form-group { flex:1; }

        .admin-panel { margin-top:40px; padding:25px; background-color:white; border-radius:var(--border-radius); box-shadow:var(--box-shadow); display:none; }
        .login-container { text-align:center; margin:30px 0; }

        .loading-spinner { display:none; border:4px solid rgba(0,0,0,0.1); border-radius:50%; border-top:4px solid var(--primary-color); width:40px; height:40px; animation:spin 1s linear infinite; margin:20px auto; position: relative; z-index: 1; }
        @keyframes spin { 0% { transform:rotate(0deg);} 100% { transform:rotate(360deg);} }

        .start-list-table { width:100%; border-collapse:collapse; margin-top:20px; }
        .start-list-table th, .start-list-table td { padding:12px; text-align:left; border-bottom:1px solid #eee; }
        .start-list-table th { background-color:#f8f9fa; font-weight:600; color:var(--dark-color); }

        .action-btn { padding:6px 12px; margin:0 2px; border:none; border-radius:4px; color:white; cursor:pointer; font-size:0.8rem; transition:var(--transition); }
        .edit-btn { background-color:var(--primary-color); }
        .delete-btn { background-color:var(--danger-color); }

        .status-badge { display:inline-block; padding:4px 10px; border-radius:12px; font-size:0.75rem; font-weight:600; color:white; }
        .status-pending { background-color:var(--warning-color); }
        .status-waiting { background-color:var(--primary-color); }
        .status-completed { background-color:var(--success-color); }

        .status-filter { margin-bottom:15px; padding:8px 12px; border-radius:var(--border-radius); border:1px solid #ddd; background-color:white; font-family:'Poppins',sans-serif; }

        /* Styles for categories/modalities lists - vertical, columns and scroll */
        .options-list { display:grid; grid-template-columns:repeat(2,1fr); gap:8px; max-height:180px; overflow:auto; padding:8px; border:1px solid #eee; border-radius:6px; margin-top:8px; }
        .options-list .option-item { display:flex; align-items:center; gap:8px; }
        .options-controls { display:flex; gap:8px; margin-top:8px; }

        @media (max-width:1200px) { .races-grid { grid-template-columns:repeat(auto-fill,minmax(280px,1fr)); } }
        @media (max-width:768px) {
            body { padding:15px; }
            .races-grid { grid-template-columns:1fr; }
            .form-row { flex-direction:column; gap:0; }
            .modal-content { margin:10% auto; padding:20px; width:95%; }
            .admin-actions { flex-direction:column; }
            .admin-actions .btn { width:100%; }
            h1 { font-size:2rem; }
            .options-list { grid-template-columns:repeat(1,1fr); }
        }
        @media (max-width:480px) {
            .nav-tabs { flex-direction:column; }
            .nav-tab { text-align:center; border-bottom:1px solid #eee; border-left:3px solid transparent; }
            .nav-tab.active { border-bottom-color:#eee; border-left-color:var(--primary-color); }
        }

        .text-center { text-align:center; }
        .mb-20 { margin-bottom:20px; }
        .hidden { display:none !important; }
        .image-preview { max-width:100%; height:auto; border-radius:var(--border-radius); margin-top:10px; border:1px solid #ddd; display:none; width:320px; height:240px; object-fit:cover; }
        .error-message { color:var(--danger-color); font-size:0.85rem; margin-top:5px; display:none; }
        .tab-content { display:none; }
        .tab-content.active { display:block; }
    </style>
</head>
<body>
    <header>
        <img src="assets/img/Logo-RC4-Sports.png" alt="Logo RC4 Sports" class="logo" onerror="this.style.display='none'">
        <h1>Ranking Ubatuba de Ciclismo - R.U.C.</h1>
        <p class="subtitle">Inscreva-se nas próximas provas e desafie seus limites!</p>
    </header>

    <div class="nav-tabs">
        <button class="nav-tab active" data-tab="active-races">Provas Ativas</button>
        <button class="nav-tab" data-tab="finished-races">Provas Finalizadas</button>
    </div>

    <div id="active-races" class="tab-content active">
        <div id="races-container" class="races-grid">
            <div class="loading-spinner" id="races-spinner"></div>
        </div>
    </div>

    <div id="finished-races" class="tab-content">
        <div id="finished-races-container" class="races-grid">
            <div class="loading-spinner" id="finished-races-spinner"></div>
        </div>
    </div>

    <div class="login-container" id="login-section">
        <button id="login-btn" class="btn btn-primary">Login Admin</button>
    </div>

    <div class="admin-panel" id="admin-panel" aria-hidden="true">
        <h2>Painel Administrativo</h2>
        <p>Você está logado como administrador.</p>
        <button id="add-race-btn" class="btn btn-primary">Adicionar Nova Prova</button>
        <button id="logout-btn" class="btn btn-danger">Logout</button>
    </div>

    <!-- Register Modal -->
    <div id="register-modal" class="modal" role="dialog" aria-modal="true">
        <div class="modal-content">
            <span class="close" title="Fechar">&times;</span>
            <h2>Inscrição na Prova</h2>
            <p id="race-selected-name" style="font-weight:bold;margin-bottom:20px;"></p>

            <div class="form-group">
                <label for="full-name">Nome Completo:</label>
                <input type="text" id="full-name" required>
                <div class="error-message" id="full-name-error">Por favor, informe seu nome completo.</div>
            </div>

            <div class="form-group">
                <label for="birth-date">Data de Nascimento (DD-MM-AAAA):</label>
                <input type="text" id="birth-date" placeholder="DD-MM-AAAA" required>
                <div class="error-message" id="birth-date-error">Por favor, informe uma data válida no formato DD-MM-AAAA.</div>
            </div>

            <div class="form-group">
                <label for="phone">Telefone:</label>
                <input type="tel" id="phone" placeholder="(00) 00000-0000" required>
                <div class="error-message" id="phone-error">Por favor, informe um telefone válido.</div>
            </div>

            <div class="form-group">
                <label for="voucher-code">Código de Desconto/Voucher (opcional):</label>
                <input type="text" id="voucher-code" placeholder="Digite o código de desconto">
            </div>

            <div id="category-section" class="form-group" style="display:none;">
                <label for="category">Categoria:</label>
                <select id="category" required>
                    <option value="">Selecione sua categoria</option>
                </select>
                <div class="error-message" id="category-error">Por favor, selecione uma categoria.</div>
            </div>

            <div id="modality-section" class="form-group" style="display:none;">
                <label for="modality">Modalidade:</label>
                <select id="modality" required>
                    <option value="">Selecione sua modalidade</option>
                </select>
                <div class="error-message" id="modality-error">Por favor, selecione uma modalidade.</div>
            </div>

            <div class="loading-spinner" id="register-spinner"></div>
            <button id="confirm-register-btn" class="btn btn-success">Confirmar Inscrição</button>
        </div>
    </div>

    <!-- Login Modal -->
    <div id="login-modal" class="modal" role="dialog" aria-modal="true">
        <div class="modal-content">
            <span class="close" title="Fechar">&times;</span>
            <h2>Login Administrativo</h2>
            <div class="form-group">
                <label for="admin-email">Email:</label>
                <input type="email" id="admin-email" required>
            </div>
            <div class="form-group">
                <label for="admin-password">Senha:</label>
                <input type="password" id="admin-password" required>
            </div>
            <button id="confirm-login-btn" class="btn btn-success">Login</button>
            <p id="login-error" style="color:red; display:none;">Email ou senha incorretos.</p>
        </div>
    </div>

    <!-- Race Modal -->
    <div id="race-modal" class="modal">
        <div class="modal-content">
            <span class="close" title="Fechar">&times;</span>
            <h2 id="race-modal-title">Adicionar Nova Prova</h2>

            <div class="form-group">
                <label for="race-name">Nome da Prova:</label>
                <input type="text" id="race-name" required>
                <div class="error-message" id="race-name-error">Por favor, informe o nome da prova.</div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="race-date">Data da Prova:</label>
                    <input type="date" id="race-date" required>
                    <div class="error-message" id="race-date-error">Por favor, selecione uma data futura.</div>
                </div>

                <div class="form-group">
                    <label for="race-price">Valor da Inscrição (R$):</label>
                    <input type="number" id="race-price" min="0" step="0.01" required>
                    <div class="error-message" id="race-price-error">Por favor, informe um valor válido.</div>
                </div>
            </div>

            <div class="form-group">
                <label for="race-description">Descrição Resumida:</label>
                <textarea id="race-description" rows="3" placeholder="Breve descrição da prova..."></textarea>
            </div>

            <div class="form-group">
                <label for="race-regulation">Regulamento (texto completo):</label>
                <textarea id="race-regulation" rows="6" placeholder="Cole o texto completo do regulamento aqui..."></textarea>
            </div>

            <div class="form-group">
                <label for="race-image-url">URL da Imagem Compartilhada no Google Drive:</label>
                <input type="text" id="race-image-url" placeholder="Cole o link do Google Drive ou outra URL pública">
                <div class="error-message" id="race-image-error">Para melhor visualização a imagem deve ter 640x480px</div>
                <img id="image-preview" class="image-preview" style="display:none;">
            </div>

            <div class="form-group">
                <label for="results-link">Link dos Resultados (opcional):</label>
                <input type="text" id="results-link" placeholder="https://...">
            </div>

            <div class="options-container">
                <div class="options-title">Opções de Inscrição:</div>
                <div>
                    <input type="checkbox" id="use-categories" class="options-checkbox">
                    <label for="use-categories">Usar Categorias</label>
                </div>
                <div class="options-controls" style="display:none;" id="categories-controls">
                    <button id="cat-checkall" type="button" class="btn btn-small btn-primary">Marcar Todos</button>
                    <button id="cat-uncheckall" type="button" class="btn btn-small btn-danger">Desmarcar Todos</button>
                </div>
                <div id="categories-list" class="options-list" style="display:none;"></div>

                <div style="margin-top:15px;">
                    <input type="checkbox" id="use-modalities" class="options-checkbox">
                    <label for="use-modalities">Usar Modalidades</label>
                </div>
                <div class="options-controls" style="display:none;" id="modalities-controls">
                    <button id="mod-checkall" type="button" class="btn btn-small btn-primary">Marcar Todos</button>
                    <button id="mod-uncheckall" type="button" class="btn btn-small btn-danger">Desmarcar Todos</button>
                </div>
                <div id="modalities-list" class="options-list" style="display:none;"></div>
            </div>

            <div class="loading-spinner" id="race-spinner"></div>
            <button id="save-race-btn" class="btn btn-success">Salvar Prova</button>
            <button id="delete-race-btn" class="btn btn-danger" style="display:none; margin-top:10px;">Excluir Prova</button>
        </div>
    </div>

    <!-- Details Modal -->
    <div id="details-modal" class="modal">
        <div class="modal-content">
            <span class="close" title="Fechar">&times;</span>
            <h2 id="details-modal-title">Detalhes da Prova</h2>
            <div id="details-content"></div>
        </div>
    </div>

    <!-- Regulation Modal -->
    <div id="regulation-modal" class="modal">
        <div class="modal-content">
            <span class="close" title="Fechar">&times;</span>
            <h2 id="regulation-modal-title">Regulamento da Prova</h2>
            <div id="regulation-content"></div>
        </div>
    </div>

    <!-- Startlist Modal -->
    <div id="startlist-modal" class="modal start-list-modal">
        <div class="modal-content">
            <span class="close" title="Fechar">&times;</span>
            <h2 id="startlist-modal-title">Start List</h2>

            <div id="startlist-filter-container" style="display:none;">
                <select class="status-filter" id="startlist-status-filter">
                    <option value="all">Todos os Status</option>
                    <option value="pending">Contato Pendente</option>
                    <option value="waiting">Aguardando Pagamento</option>
                    <option value="completed">Pagamento Concluído</option>
                </select>
            </div>

            <table class="start-list-table">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Nome</th>
                        <th id="startlist-category-header" style="display:none;">Categoria</th>
                        <th id="startlist-modality-header" style="display:none;">Modalidade</th>
                        <th id="startlist-admin-header" style="display:none;">Data Nasc.</th>
                        <th id="startlist-phone-header" style="display:none;">Telefone</th>
                        <th id="startlist-voucher-header" style="display:none;">Voucher</th>
                        <th id="startlist-status-header" style="display:none;">Status</th>
                        <th id="startlist-actions-header" style="display:none;">Ações</th>
                    </tr>
                </thead>
                <tbody id="startlist-content"></tbody>
            </table>
        </div>
    </div>

    <!-- Edit Rider Modal -->
    <div id="edit-rider-modal" class="modal" role="dialog" aria-modal="true">
        <div class="modal-content">
            <span class="close" title="Fechar">&times;</span>
            <h2>Editar Inscrição</h2>
            
            <div class="form-group">
                <label for="edit-rider-name">Nome Completo:</label>
                <input type="text" id="edit-rider-name" required>
            </div>

            <div class="form-group">
                <label for="edit-birth-date">Data de Nascimento (DD-MM-AAAA):</label>
                <input type="text" id="edit-birth-date" placeholder="DD-MM-AAAA" required>
            </div>

            <div class="form-group">
                <label for="edit-phone">Telefone:</label>
                <input type="tel" id="edit-phone" placeholder="(00) 00000-0000" required>
            </div>

            <div class="form-group">
                <label for="edit-voucher">Código de Desconto/Voucher:</label>
                <input type="text" id="edit-voucher" placeholder="Digite o código de desconto">
            </div>

            <div class="form-group">
                <label for="edit-category">Categoria:</label>
                <select id="edit-category">
                    <option value="">Selecione</option>
                </select>
            </div>

            <div class="form-group">
                <label for="edit-modality">Modalidade:</label>
                <select id="edit-modality">
                    <option value="">Selecione</option>
                </select>
            </div>

            <div class="form-group">
                <label for="edit-status">Status:</label>
                <select id="edit-status" required>
                    <option value="pending">Contato Pendente</option>
                    <option value="completed">Pagamento Realizado</option>
                </select>
            </div>

            <div class="loading-spinner" id="edit-rider-spinner"></div>
            <button id="save-rider-btn" class="btn btn-success">Salvar Alterações</button>
        </div>
    </div>

<script>
    // ---------- FIREBASE ----------
    const firebaseConfig = {
            apiKey: "AIzaSyAwkcOWdZf46_TZQlHE2N_k0C0wVbmqKks",
            authDomain: "rankingubatubadeciclismo.firebaseapp.com",
            projectId: "rankingubatubadeciclismo",
            storageBucket: "rankingubatubadeciclismo.firebasestorage.app",
            messagingSenderId: "164808638910",
            appId: "1:164808638910:web:0278c92e92872f038939ef"
        };

    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();
    const auth = firebase.auth();

    // ---------- GLOBAIS ----------
    let isAdmin = false;
    let currentRaceId = null;
    let currentRiderId = null;
    let editingRaceId = null;
    let currentTab = 'active-races';

    let isSubmittingRegistration = false;
    let isSavingRace = false;

    const allCategories = [
        'Trail Run 6,5km 13-19 anos','Trail Run 6,5km 20-29 anos','Trail Run 6,5km 30-39 anos','Trail Run 6,5km 40-49 anos','Trail Run 6,5km 50-59 anos', 'Trail Run 6,5km 60+','Trail Run 6,5km Dupla Mista', 'Trail Run 6,5km Atleta Local','Trail Run 12,5km 13-19 anos','Trail Run 12,5km 20-29 anos','Trail Run 12,5km 30-39 anos','Trail Run 12,5km 40-49 anos','Trail Run 12,5km 50-59 anos', 'Trail Run 12,5km 60+','Trail Run 12,5km Dupla Mista', 'Trail Run 12,5km Atleta Local','Trail Run Kids'
    ];

    const allModalities = [
        'Fast Triathlon','Aquathlon','Aquathlon Revezamento','Maratona Aquática 1500',
        'Maratona Aquática 3000','Kids','Corrida Noturna','Corrida','Triathlon Olímpico',
        'Short Triathlon','5K','10K','21K','42K'
    ];

    // ---------- FIREBASE PATHS (single source) ----------
    const PATH_RACES = 'EventRaces';
    const PATH_REGISTRATIONS = 'EventRegistrations';

    // ---------- FUNÇÃO PARA CORRIGIR TIMEZONE DA DATA ----------
    function fixTimezoneDate(dateString) {
        if (!dateString) return "";
        
        // Se já estiver no formato DD-MM-AAAA, retorna como está
        if (/^\d{2}-\d{2}-\d{4}$/.test(dateString)) {
            return dateString;
        }
        
        // Se estiver no formato AAAA-MM-DD (do input type="date" ou Firebase)
        if (/^\d{4}-\d{2}-\d{2}$/.test(dateString)) {
            const date = new Date(dateString);
            
            // Corrigir timezone: adicionar 1 dia para compensar
            date.setDate(date.getDate() + 1);
            
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();
            
            return `${day}-${month}-${year}`;
        }
        
        // Se for outro formato, retorna como está
        return dateString;
    }

    // ---------- FIREBASE OPERATIONS ----------
    function saveRaceToFirebase(raceData) {
        return database.ref(`${PATH_RACES}/${raceData.id}`).set(raceData);
    }

    function deleteRaceFromFirebase(raceId) {
        return database.ref(`${PATH_RACES}/${raceId}`).remove();
    }

    function saveRegistrationToFirebase(registrationData) {
        // Aplicar correção de timezone na data de nascimento
        if (registrationData.birthDate) {
            registrationData.birthDate = fixTimezoneDate(registrationData.birthDate);
        }
        
        // Deduplicate: check if a registration with same phone+raceId already exists
        const phoneNorm = (registrationData.phone || '').replace(/\D/g, '');
        return database.ref(PATH_REGISTRATIONS)
            .orderByChild('raceId')
            .equalTo(registrationData.raceId)
            .once('value')
            .then(snapshot => {
                const existing = snapshot.val() || {};
                const keys = Object.keys(existing);
                for (let k of keys) {
                    const r = existing[k];
                    if (r && (r.phone || '').replace(/\D/g, '') === phoneNorm && (r.name || '').trim().toLowerCase() === (registrationData.name || '').trim().toLowerCase()) {
                        // Found duplicate -> return rejected promise so caller can handle
                        return Promise.reject(new Error('duplicate_registration'));
                    }
                }

                const registrationId = database.ref().child(PATH_REGISTRATIONS).push().key;
                registrationData.id = registrationId;
                registrationData.timestamp = Date.now();
                return database.ref(`${PATH_REGISTRATIONS}/${registrationId}`).set(registrationData);
            });
    }

    function updateRegistrationStatus(registrationId, status) {
        return database.ref(`${PATH_REGISTRATIONS}/${registrationId}/status`).set(status);
    }

    function updateRegistrationData(registrationId, updatedData) {
        // Aplicar correção de timezone na data de nascimento se houver
        if (updatedData.birthDate) {
            updatedData.birthDate = fixTimezoneDate(updatedData.birthDate);
        }
        return database.ref(`${PATH_REGISTRATIONS}/${registrationId}`).update(updatedData);
    }

    function deleteRegistrationFromFirebase(registrationId) {
        return database.ref(`${PATH_REGISTRATIONS}/${registrationId}`).remove();
    }

    // ---------- UTILITIES ----------
    function formatDate(dateString) {
        if (!dateString) return "Data inválida";
        const date = new Date(dateString);
        if (isNaN(date.getTime())) return "Data inválida";
        const options = { day: '2-digit', month: '2-digit', year: 'numeric' };
        return date.toLocaleDateString('pt-BR', options);
    }

    function getStatusClass(status) {
        if (!status) return 'status-pending';
        switch(status.toString().trim().toLowerCase()) {
            case 'pending': return 'status-pending';
            case 'waiting': return 'status-waiting';
            case 'completed': return 'status-completed';
            default: return 'status-pending';
        }
    }
    
    function getStatusText(status) {
        if (!status) return 'Contato Pendente';
        switch(status.toString().trim().toLowerCase()) {
            case 'pending': return 'Contato Pendente';
            case 'waiting': return 'Aguardando Pagamento';
            case 'completed': return 'Pagamento Realizado';
            default: return 'Contato Pendente';
        }
    }

    // ---------- Normalizador Google Drive ----------
    function normalizeGoogleDriveImage(url) {
        if (!url) return "";
        try {
            url = url.trim();
            if (url.includes("/file/d/")) {
                const id = url.split("/file/d/")[1].split("/")[0];
                return `https://lh3.googleusercontent.com/d/${id}`;
            }
            if (url.includes("drive.google.com/open?id=")) {
                const id = url.split('id=')[1].split('&')[0];
                return `https://lh3.googleusercontent.com/d/${id}`;
            }
            if (url.includes("lh3.googleusercontent.com/d/")) return url;
            return url; // accept other public URLs
        } catch (e) {
            return '';
        }
    }

    // ---------- Preview e validação 640x480 ----------
    function updateImagePreview(rawUrl) {
        const preview = document.getElementById('image-preview');
        const errorEl = document.getElementById('race-image-error');

        if (!preview) return;

        if (!rawUrl) {
            preview.style.display = 'none';
            if (errorEl) errorEl.style.display = 'none';
            return;
        }

        const url = normalizeGoogleDriveImage(rawUrl);
        preview.src = url;

        if (errorEl) errorEl.style.display = 'none';

        preview.onload = function() {
            const w = preview.naturalWidth || 0;
            const h = preview.naturalHeight || 0;

            if (w && h) {
                if (w === 640 && h === 480) {
                    if (errorEl) errorEl.style.display = 'none';
                } else {
                    if (errorEl) errorEl.style.display = 'block';
                }
            } else {
                if (errorEl) errorEl.style.display = 'none';
            }
            preview.style.display = 'block';
        };

        preview.onerror = function() {
            if (errorEl) {
                errorEl.textContent = 'Não foi possível carregar a imagem. Verifique o link.';
                errorEl.style.display = 'block';
            }
            preview.style.display = 'none';
        };
    }

    // ---------- Populate lists ----------
    function populateCategoriesList() {
        const categoriesList = document.getElementById('categories-list');
        if (!categoriesList) return;
        categoriesList.innerHTML = '';
        allCategories.forEach(category => {
            const div = document.createElement('div');
            div.className = 'option-item';
            const id = 'cat-' + category.replace(/\s+/g, '-').replace(/[^a-zA-Z0-9-_]/g, '');
            div.innerHTML = `<input type="checkbox" id="${id}" value="${category}" checked>
                             <label for="${id}">${category}</label>`;
            categoriesList.appendChild(div);
        });
    }

    function populateModalitiesList() {
        const modalitiesList = document.getElementById('modalities-list');
        if (!modalitiesList) return;
        modalitiesList.innerHTML = '';
        allModalities.forEach(modality => {
            const div = document.createElement('div');
            div.className = 'option-item';
            const id = 'mod-' + modality.replace(/\s+/g, '-').replace(/[^a-zA-Z0-9-_]/g, '');
            div.innerHTML = `<input type="checkbox" id="${id}" value="${modality}" checked>
                             <label for="${id}">${modality}</label>`;
            modalitiesList.appendChild(div);
        });
    }

    // ---------- Load Races FROM FIREBASE ----------
    function loadRaces() {
    const isActiveTab = currentTab === 'active-races';
    console.log('=== LOAD RACES === currentTab:', currentTab, 'isActiveTab:', isActiveTab); // ← DEBUG
    const spinner = isActiveTab ? document.getElementById('races-spinner') : document.getElementById('finished-races-spinner');
    const container = isActiveTab ? document.getElementById('races-container') : document.getElementById('finished-races-container');

    console.log('=== LOAD RACES INICIADO === Aba:', currentTab);
console.log('Container selecionado:', container);
    console.log('Container visibility:', container ? window.getComputedStyle(container).display : 'null');

    if (container && container.getAttribute('data-loading') === 'true') {
        console.log('Já está carregando, ignorando chamada duplicada');
        return;
    }
    if (container) container.setAttribute('data-loading', 'true');

    if (spinner) spinner.style.display = 'block';
    if (container) container.innerHTML = '';

    database.ref(PATH_RACES).once('value')
        .then(snapshot => {
            console.log('Dados recebidos do Firebase para aba:', currentTab);
            if (spinner) spinner.style.display = 'none';
            const races = snapshot.val() || {};
            console.log('Provas encontradas:', Object.keys(races).length);
            let hasRaces = false;

            Object.keys(races).forEach(raceId => {
    const race = races[raceId];
    const status = (race && race.status) ? race.status.toString().trim().toLowerCase() : 'open';
    
    let shouldShow = false;
    
    if (currentTab === 'active-races') {
        shouldShow = status !== 'finished';
    } else if (currentTab === 'finished-races') {
        shouldShow = status === 'finished';
    }
    
    if (shouldShow) {
        console.log('✓ Adicionando prova:', race.name, 'no tab:', currentTab);
        const raceElement = createRaceElement(raceId, race);
        if (container && raceElement) {
            container.appendChild(raceElement);
            console.log('✓ Elemento adicionado ao container. Children count:', container.children.length);
            hasRaces = true;
} else {
                console.log('✗ Problema: container ou raceElement é null');
            }
        }
    });

    // DEBUG: Verificar o que realmente está no container
    console.log('Container final children:', container.children.length);
    console.log('Container innerHTML:', container.innerHTML);
            console.log('=== LOAD RACES FINALIZADO === Provas mostradas:', hasRaces);
            if (!hasRaces && container) {
                container.innerHTML = isActiveTab ? 
                    '<p class="text-center">Não há provas ativas no momento.</p>' : 
                    '<p class="text-center">Não há provas finalizadas.</p>';
            }
            if (container) container.removeAttribute('data-loading');
        })
        .catch(error => {
            console.error('Erro ao carregar provas:', error);
            if (spinner) spinner.style.display = 'none';
            if (container) {
                container.innerHTML = '<p class="text-center">Erro ao carregar provas.</p>';
                container.removeAttribute('data-loading');
            }
        });
}

    // ---------- Create race card ----------
    function createRaceElement(raceId, race) {
    console.log('CRIANDO ELEMENTO PARA PROVA:', raceId, race && race.name);
    console.log('Status da prova:', race && race.status);
    
    const raceElement = document.createElement('div');
    raceElement.className = 'race-card';
    raceElement.id = `race-${raceId}`;

    let statusClass, statusText;
    const status = race && race.status ? race.status.toString().trim().toLowerCase() : 'open';
    console.log('Status normalizado:', status);
    
    if (status === 'finished') {
        statusClass = 'status-finished'; 
        statusText = 'Prova Finalizada';
        console.log('✓ Definindo como prova finalizada');
    } else if (status === 'open') {
        statusClass = 'status-open'; 
        statusText = 'Inscrições Abertas';
    } else {
        statusClass = 'status-closed'; 
        statusText = 'Inscrições Encerradas';
    }

    const imageUrl = race && race.imageUrl ? race.imageUrl : '';
    let imageHtml = imageUrl ? `<img src="${imageUrl}" alt="${(race && race.name)||''}" class="race-image">` : '<div style="height:100%;display:flex;align-items:center;justify-content:center;color:#999;">Sem Imagem</div>';

    let raceHTML = `
        <div class="race-image-container">${imageHtml}</div>
        <div class="race-content">
            <h3 class="race-title">${(race && race.name)||''}</h3>
            <div class="race-meta">
                <span class="race-date">${formatDate(race && race.date)}</span>
                <span class="race-price">R$${Number((race && race.price)||0).toFixed(2)}</span>
            </div>
            <span class="race-status ${statusClass}">${statusText}</span>
            ${race && race.description ? `<p class="race-description">${race.description}</p>` : ''}
    `;

    if (status === 'open') {
        raceHTML += `<button class="btn btn-primary register-btn" data-race-id="${raceId}">Fazer Inscrição</button>`;
    }

    raceHTML += `
        <button class="btn btn-primary details-btn" data-race-id="${raceId}">Detalhes da Prova</button>
        <button class="btn btn-primary regulation-btn" data-race-id="${raceId}">Ver Regulamento</button>
        <button class="btn btn-primary startlist-btn" data-race-id="${raceId}">Ver Start List</button>
    `;

    if (status === 'finished' && race && race.resultsLink) {
        raceHTML += `<button class="btn btn-warning results-btn" data-race-id="${raceId}">Ver Resultados</button>`;
    }

    if (isAdmin) {
        raceHTML += `
            <div class="admin-actions" style="margin-top:15px;">
                ${status !== 'finished' ? `
                    <button class="btn ${status === 'open' ? 'btn-danger' : 'btn-success'} toggle-status-btn" 
                            data-race-id="${raceId}" data-current-status="${status}">
                        ${status === 'open' ? 'Encerrar Inscrições' : 'Abrir Inscrições'}
                    </button>
                    <button class="btn btn-danger finish-race-btn" data-race-id="${raceId}">Finalizar Prova</button>
                ` : `
                    <button class="btn btn-success activate-race-btn" data-race-id="${raceId}">Ativar Prova</button>
                `}
                <button class="btn btn-primary edit-race-btn" data-race-id="${raceId}">Editar Prova</button>
                <button class="btn btn-danger delete-race-btn" data-race-id="${raceId}">Excluir Prova</button>
            </div>
        `;
    }

    raceHTML += `</div>`;
    console.log('Elemento criado com HTML:', raceHTML);
    raceElement.innerHTML = raceHTML;

    setTimeout(() => {
        const registerBtn = raceElement.querySelector('.register-btn');
        if (registerBtn) registerBtn.addEventListener('click', () => openRegisterModal(raceId, race));

        const detailsBtn = raceElement.querySelector('.details-btn');
        if (detailsBtn) detailsBtn.addEventListener('click', () => openDetailsModal(raceId, race));

        const regulationBtn = raceElement.querySelector('.regulation-btn');
        if (regulationBtn) regulationBtn.addEventListener('click', () => openRegulationModal(raceId, race));

        const startlistBtn = raceElement.querySelector('.startlist-btn');
        if (startlistBtn) startlistBtn.addEventListener('click', () => openStartListModal(raceId, race));

        const resultsBtn = raceElement.querySelector('.results-btn');
        if (resultsBtn) resultsBtn.addEventListener('click', () => { if (race && race.resultsLink) window.open(race.resultsLink, '_blank'); });

        const toggleBtn = raceElement.querySelector('.toggle-status-btn');
        const finishBtn = raceElement.querySelector('.finish-race-btn');
        const activateBtn = raceElement.querySelector('.activate-race-btn');
        const editBtn = raceElement.querySelector('.edit-race-btn');
        const deleteBtn = raceElement.querySelector('.delete-race-btn');

        if (toggleBtn) toggleBtn.addEventListener('click', (e) => toggleRaceStatus(e.currentTarget.dataset.raceId, e.currentTarget.dataset.currentStatus));
        if (finishBtn) finishBtn.addEventListener('click', (e) => finishRace(e.currentTarget.dataset.raceId));
        if (activateBtn) activateBtn.addEventListener('click', (e) => activateRace(e.currentTarget.dataset.raceId));
        if (editBtn) editBtn.addEventListener('click', (e) => {
            openRaceModal(e.currentTarget.dataset.raceId, race);
        });
        if (deleteBtn) deleteBtn.addEventListener('click', (e) => {
            if (confirm('Deseja realmente excluir esta prova?')) deleteRace(e.currentTarget.dataset.raceId);
        });
    }, 30);

    return raceElement;
}
    // ---------- Login / Auth ----------
    function openLoginModal() {
        const loginModal = document.getElementById('login-modal');
        if (loginModal) loginModal.style.display = 'block';
    }

    function loginAdmin() {
        const email = document.getElementById('admin-email').value.trim();
        const password = document.getElementById('admin-password').value.trim();
        const loginError = document.getElementById('login-error');
        if (loginError) loginError.style.display = 'none';

        if (!email || !password) { if (loginError) { loginError.textContent = 'Preencha email e senha.'; loginError.style.display = 'block'; } return; }

        auth.signInWithEmailAndPassword(email, password)
            .then(() => {
                const loginModal = document.getElementById('login-modal');
                if (loginModal) loginModal.style.display = 'none';
            })
            .catch(err => {
                console.error('Erro login:', err);
                if (loginError) { loginError.textContent = 'Email ou senha incorretos.'; loginError.style.display = 'block'; }
            });
    }

    function logoutAdmin() {
        auth.signOut().catch(err => console.error('Erro ao deslogar:', err));
    }

    auth.onAuthStateChanged(user => {
        const adminPanel = document.getElementById('admin-panel');
        const loginBtn = document.getElementById('login-btn');

        if (user) {
            isAdmin = true;
            if (adminPanel) adminPanel.style.display = 'block';
            if (loginBtn) { loginBtn.textContent = 'Admin Logado'; loginBtn.disabled = true; }
        } else {
            isAdmin = false;
            if (adminPanel) adminPanel.style.display = 'none';
            if (loginBtn) { loginBtn.textContent = 'Login Admin'; loginBtn.disabled = false; }
        }

    });

    // ---------- Register / Confirm ----------
    function openRegisterModal(raceId, race) {
        currentRaceId = raceId;
        const raceSelectedName = document.getElementById('race-selected-name');
        if (raceSelectedName) raceSelectedName.textContent = race.name;

        const fullName = document.getElementById('full-name');
        const birthDate = document.getElementById('birth-date');
        const phone = document.getElementById('phone');
        const voucherCode = document.getElementById('voucher-code');

        if (fullName) fullName.value = '';
        if (birthDate) birthDate.value = '';
        if (phone) phone.value = '';
        if (voucherCode) voucherCode.value = '';

        const categorySection = document.getElementById('category-section');
        const modalitySection = document.getElementById('modality-section');
        const categoryInput = document.getElementById('category');
        const modalityInput = document.getElementById('modality');

        if (categoryInput) categoryInput.innerHTML = '<option value="">Selecione sua categoria</option>';
        if (modalityInput) modalityInput.innerHTML = '<option value="">Selecione sua modalidade</option>';

        if (race && race.useCategories && race.categories && categoryInput) {
            race.categories.forEach(cat => {
                const opt = document.createElement('option'); opt.value = cat; opt.textContent = cat; categoryInput.appendChild(opt);
            });
            if (categorySection) categorySection.style.display = 'block';
        } else if (categorySection) categorySection.style.display = 'none';

        if (race && race.useModalities && race.modalities && modalityInput) {
            race.modalities.forEach(mod => {
                const opt = document.createElement('option'); opt.value = mod; opt.textContent = mod; modalityInput.appendChild(opt);
            });
            if (modalitySection) modalitySection.style.display = 'block';
        } else if (modalitySection) modalitySection.style.display = 'none';

        const registerModal = document.getElementById('register-modal');
        if (registerModal) registerModal.style.display = 'block';
    }

    function confirmRegistration() {
        if (isSubmittingRegistration) return; // prevent double submit
        isSubmittingRegistration = true;
        const registerSpinner = document.getElementById('register-spinner');
        const confirmBtn = document.getElementById('confirm-register-btn');
        if (confirmBtn) confirmBtn.disabled = true;
        if (registerSpinner) registerSpinner.style.display = 'block';

        const fullName = document.getElementById('full-name');
        const birthDate = document.getElementById('birth-date');
        const phone = document.getElementById('phone');
        const voucherCode = document.getElementById('voucher-code');
        const category = document.getElementById('category');
        const modality = document.getElementById('modality');
        const raceSelectedName = document.getElementById('race-selected-name');

        if (!fullName || !birthDate || !phone || !raceSelectedName) {
            alert('Erro no formulário.');
            finalizeRegistrationSubmit();
            return;
        }

        const name = fullName.value.trim();
        const birthDateValue = birthDate.value;
        const phoneValue = phone.value.trim();
        const voucherCodeValue = voucherCode ? voucherCode.value.trim() : '';
        const categoryValue = category ? category.value : '';
        const modalityValue = modality ? modality.value : '';

        if (!name) { alert('Por favor, informe seu nome completo.'); finalizeRegistrationSubmit(); return; }
        if (!birthDateValue || !/^\d{2}-\d{2}-\d{4}$/.test(birthDateValue)) { alert('Por favor, informe uma data de nascimento válida no formato DD-MM-AAAA.'); finalizeRegistrationSubmit(); return; }
        const phoneDigits = phoneValue.replace(/\D/g, '');
        if (phoneDigits.length < 10) { alert('Por favor, insira um telefone válido com DDD.'); finalizeRegistrationSubmit(); return; }

        // Buscar dados completos da prova
        database.ref(`${PATH_RACES}/${currentRaceId}`).once('value')
            .then(snapshot => {
                const race = snapshot.val();
                if (!race) {
                    alert('Prova não encontrada.');
                    throw new Error('race_not_found');
                }

                // Salvar inscrição no Firebase (com checagem de duplicidade)
                const registrationData = {
                    raceId: currentRaceId,
                    raceName: race.name,
                    name: name,
                    birthDate: birthDateValue,
                    phone: phoneValue,
                    voucherCode: voucherCodeValue,
                    category: categoryValue,
                    modality: modalityValue,
                    status: 'pending',
                    timestamp: Date.now()
                };

                return saveRegistrationToFirebase(registrationData)
                    .then(() => ({ race, registrationData }))
                    .catch(err => {
                        if (err && err.message === 'duplicate_registration') {
                            alert('Inscrição já cadastrada anteriormente para este atleta nesta prova.');
                            throw err;
                        }
                        throw err;
                    });
            })
            .then(({ race, registrationData }) => {
                let whatsappMsg = `Olá, gostaria de confirmar a Inscrição no Ranking Ubatuba de Ciclismo!\n\n` +
                                  `*Prova:* ${raceSelectedName.textContent}\n` +
                                  `*Nome:* ${registrationData.name}\n` +
                                  `*Data Nasc.:* ${registrationData.birthDate}\n` +
                                  `*Telefone:* ${registrationData.phone}\n`;

                if (registrationData.voucherCode) whatsappMsg += `*Código de Desconto:* ${registrationData.voucherCode}\n`;
                if (registrationData.category) whatsappMsg += `*Categoria:* ${registrationData.category}\n`;
                if (registrationData.modality) whatsappMsg += `*Modalidade:* ${registrationData.modality}\n`;

                // Buscar preço atual da prova
                database.ref(`${PATH_RACES}/${currentRaceId}/price`).once('value')
                    .then(priceSnapshot => {
                        const price = priceSnapshot.val() || 0;
                        whatsappMsg += `*Valor:* R$${Number(price).toFixed(2)}`;

                        window.open(`https://wa.me/5512997689586?text=${encodeURIComponent(whatsappMsg)}`, '_blank');

                        const registerModal = document.getElementById('register-modal');
                        if (registerModal) registerModal.style.display = 'none';
                        alert('Inscrição enviada! Confirme o pagamento via WhatsApp.');
                    })
                    .catch(err => {
                        console.error('Erro ao buscar preço:', err);
                        alert('Inscrição salva, mas houve erro ao buscar o preço.');
                    })
                    .finally(() => {
                        finalizeRegistrationSubmit();
                        loadRaces();
                    });
            })
            .catch(error => {
                console.error('Erro ao salvar inscrição:', error);
                if (error && error.message === 'duplicate_registration') {
                    // mensagem já mostrada
                } else {
                    alert('Erro ao processar inscrição. Tente novamente.');
                }
                finalizeRegistrationSubmit();
            });
    }

    function finalizeRegistrationSubmit() {
        isSubmittingRegistration = false;
        const registerSpinner = document.getElementById('register-spinner');
        const confirmBtn = document.getElementById('confirm-register-btn');
        if (confirmBtn) confirmBtn.disabled = false;
        if (registerSpinner) registerSpinner.style.display = 'none';
    }

    // ---------- START LIST ----------
    function openStartListModal(raceId, race) {
        const startlistModalTitle = document.getElementById('startlist-modal-title');
        const startlistModal = document.getElementById('startlist-modal');

        if (startlistModalTitle) startlistModalTitle.textContent = `Start List - ${race.name}`;
        if (startlistModal) startlistModal.style.display = 'block';

        // controlar cabeçalhos de colunas conforme admin
        document.getElementById('startlist-category-header').style.display = race.useCategories ? '' : 'none';
        document.getElementById('startlist-modality-header').style.display = race.useModalities ? '' : 'none';

        const adminCols = [
            'startlist-admin-header',
            'startlist-phone-header',
            'startlist-voucher-header',
            'startlist-status-header',
            'startlist-actions-header'
        ];
        adminCols.forEach(id => { const el = document.getElementById(id); if (el) el.style.display = isAdmin ? '' : 'none'; });

        loadStartListData(raceId, race);
    }

    function loadStartListData(raceId, race) {
        const tbody = document.getElementById('startlist-content');
        if (!tbody) return;

        document.getElementById('startlist-category-header').style.display = race.useCategories ? '' : 'none';
        document.getElementById('startlist-modality-header').style.display = race.useModalities ? '' : 'none';
        const adminCols = [
            'startlist-admin-header',
            'startlist-phone-header',
            'startlist-voucher-header',
            'startlist-status-header',
            'startlist-actions-header'
        ];
        adminCols.forEach(id => { const el = document.getElementById(id); if (el) el.style.display = isAdmin ? '' : 'none'; });

        database.ref(PATH_REGISTRATIONS)
            .orderByChild('raceId')
            .equalTo(raceId)
            .once('value')
            .then(snapshot => {
                const registrations = snapshot.val() || {};
                let html = '';
                const keys = Object.keys(registrations);
                keys.sort((a,b)=> (registrations[a].timestamp||0)-(registrations[b].timestamp||0));
                keys.forEach((registrationId, index) => {
                    const rider = registrations[registrationId];
                    html += `<tr>
                        <td>${String(index+1).padStart(3,'0')}</td>
                        <td>${rider.name}</td>
                        ${race.useCategories ? `<td>${rider.category || '-'}</td>` : ''}
                        ${race.useModalities ? `<td>${rider.modality || '-'}</td>` : ''}
                        ${isAdmin ? `<td>${rider.birthDate}</td>` : '' }
                        ${isAdmin ? `<td>${rider.phone}</td>` : '' }
                        ${isAdmin ? `<td>${rider.voucherCode || '-'}</td>` : '' }
                        ${isAdmin ? `<td><span class="status-badge ${getStatusClass(rider.status)}">${getStatusText(rider.status)}</span></td>` : '' }
                        ${isAdmin ? `<td>
                            <button class="action-btn edit-btn" onclick="openEditRiderModal('${registrationId}')">Editar</button>
                            <button class="action-btn delete-btn" onclick="deleteRider('${registrationId}')">Excluir</button>
                        </td>` : ''}
                    </tr>`;
                });

                tbody.innerHTML = html || '<tr><td colspan="8" style="text-align:center;">Nenhum inscrito ainda</td></tr>';
            })
            .catch(error => {
                console.error('Erro ao carregar start list:', error);
                tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;color:red;">Erro ao carregar inscrições</td></tr>';
            });
    }

    // ---------- EDIT RIDER MODAL ----------
    function openEditRiderModal(registrationId) {
        currentRiderId = registrationId;
        
        // Mostrar loading
        const editSpinner = document.getElementById('edit-rider-spinner');
        if (editSpinner) editSpinner.style.display = 'block';
        
        database.ref(`${PATH_REGISTRATIONS}/${registrationId}`).once('value')
            .then(snapshot => {
                const rider = snapshot.val();
                if (!rider) {
                    alert('Inscrição não encontrada.');
                    return;
                }
                
                // Buscar dados da prova para carregar categorias/modalidades
                return database.ref(`${PATH_RACES}/${rider.raceId}`).once('value')
                    .then(raceSnapshot => {
                        const race = raceSnapshot.val();
                        if (editSpinner) editSpinner.style.display = 'none';
                        
                        // Preencher os campos
                        document.getElementById('edit-rider-name').value = rider.name || '';
                        document.getElementById('edit-birth-date').value = rider.birthDate || '';
                        document.getElementById('edit-phone').value = rider.phone || '';
                        document.getElementById('edit-voucher').value = rider.voucherCode || '';
                        document.getElementById('edit-status').value = rider.status || 'pending';
                        
                        // Configurar categorias
                        const categorySelect = document.getElementById('edit-category');
                        categorySelect.innerHTML = '<option value="">Selecione</option>';
                        if (race && race.useCategories && race.categories) {
                            race.categories.forEach(cat => {
                                const opt = document.createElement('option');
                                opt.value = cat;
                                opt.textContent = cat;
                                categorySelect.appendChild(opt);
                            });
                            categorySelect.value = rider.category || '';
                            categorySelect.closest('.form-group').style.display = 'block';
                        } else {
                            categorySelect.closest('.form-group').style.display = 'none';
                        }
                        
                        // Configurar modalidades
                        const modalitySelect = document.getElementById('edit-modality');
                        modalitySelect.innerHTML = '<option value="">Selecione</option>';
                        if (race && race.useModalities && race.modalities) {
                            race.modalities.forEach(mod => {
                                const opt = document.createElement('option');
                                opt.value = mod;
                                opt.textContent = mod;
                                modalitySelect.appendChild(opt);
                            });
                            modalitySelect.value = rider.modality || '';
                            modalitySelect.closest('.form-group').style.display = 'block';
                        } else {
                            modalitySelect.closest('.form-group').style.display = 'none';
                        }
                        
                        // Mostrar modal
                        const editModal = document.getElementById('edit-rider-modal');
                        if (editModal) editModal.style.display = 'block';
                    });
            })
            .catch(error => {
                console.error('Erro ao carregar dados do inscrito:', error);
                if (editSpinner) editSpinner.style.display = 'none';
                alert('Erro ao carregar dados do inscrito.');
            });
    }

    function saveRiderChanges() {
        const spinner = document.getElementById('edit-rider-spinner');
        const saveBtn = document.getElementById('save-rider-btn');
        
        if (!currentRiderId) return;
        
        // Desabilitar botão e mostrar loading
        if (saveBtn) saveBtn.disabled = true;
        if (spinner) spinner.style.display = 'block';
        
        // Coletar dados
        const updatedData = {
            name: document.getElementById('edit-rider-name').value.trim(),
            birthDate: document.getElementById('edit-birth-date').value.trim(),
            phone: document.getElementById('edit-phone').value.trim(),
            voucherCode: document.getElementById('edit-voucher').value.trim(),
            status: document.getElementById('edit-status').value,
            category: document.getElementById('edit-category').value || '',
            modality: document.getElementById('edit-modality').value || ''
        };
        
        // Validação básica
        if (!updatedData.name || !updatedData.birthDate || !updatedData.phone) {
            alert('Preencha os campos obrigatórios: Nome, Data de Nascimento e Telefone.');
            if (saveBtn) saveBtn.disabled = false;
            if (spinner) spinner.style.display = 'none';
            return;
        }
        
        // Salvar no Firebase
        updateRegistrationData(currentRiderId, updatedData)
            .then(() => {
                alert('Dados atualizados com sucesso!');
                
                // Fechar modal
                const editModal = document.getElementById('edit-rider-modal');
                if (editModal) editModal.style.display = 'none';
                
                // Recarregar start list se estiver aberto
                const startlistModal = document.getElementById('startlist-modal');
                if (startlistModal && startlistModal.style.display === 'block') {
                    database.ref(`${PATH_RACES}`).once('value')
                        .then(snapshot => {
                            const races = snapshot.val() || {};
                            // Encontrar a prova atual para recarregar
                            database.ref(`${PATH_REGISTRATIONS}/${currentRiderId}/raceId`).once('value')
                                .then(raceIdSnapshot => {
                                    const raceId = raceIdSnapshot.val();
                                    if (raceId && races[raceId]) {
                                        loadStartListData(raceId, races[raceId]);
                                    }
                                });
                        });
                }
            })
            .catch(error => {
                console.error('Erro ao atualizar inscrição:', error);
                alert('Erro ao atualizar inscrição. Tente novamente.');
            })
            .finally(() => {
                if (saveBtn) saveBtn.disabled = false;
                if (spinner) spinner.style.display = 'none';
            });
    }

    // ---------- PROVAS CRUD ----------
    function openRaceModal(raceId = null, raceData = null) {
        editingRaceId = raceId;
        const raceModal = document.getElementById('race-modal');
        if (!raceModal) return;

        const raceModalTitle = document.getElementById('race-modal-title');
        const raceNameInput = document.getElementById('race-name');
        const raceDateInput = document.getElementById('race-date');
        const racePriceInput = document.getElementById('race-price');
        const raceDescriptionInput = document.getElementById('race-description');
        const raceImageUrlInput = document.getElementById('race-image-url');
        const resultsLinkInput = document.getElementById('results-link');
        const deleteRaceBtn = document.getElementById('delete-race-btn');
        const raceRegulationInput = document.getElementById('race-regulation');

        if (raceId && raceData) {
            if (raceModalTitle) raceModalTitle.textContent = 'Editar Prova';
            if (raceNameInput) raceNameInput.value = raceData.name || '';
            if (raceDateInput) raceDateInput.value = raceData.date || '';
            if (racePriceInput) racePriceInput.value = raceData.price || '';
            if (raceDescriptionInput) raceDescriptionInput.value = raceData.description || '';
            if (raceImageUrlInput) raceImageUrlInput.value = raceData.imageUrl || '';
            if (resultsLinkInput) resultsLinkInput.value = raceData.resultsLink || '';
            if (raceRegulationInput) raceRegulationInput.value = raceData.regulation || '';
            if (deleteRaceBtn) deleteRaceBtn.style.display = 'inline-block';

            // set useCategories/modalities
            document.getElementById('use-categories').checked = !!raceData.useCategories;
            document.getElementById('use-modalities').checked = !!raceData.useModalities;

            // ensure lists populated and checked accordingly
            populateCategoriesList();
            populateModalitiesList();
            if (raceData.categories && raceData.categories.length) {
                raceData.categories.forEach(cat => {
                    const id = 'cat-' + cat.replace(/\s+/g, '-').replace(/[^a-zA-Z0-9-_]/g, '');
                    const el = document.getElementById(id);
                    if (el) el.checked = true;
                });
            }
            if (raceData.modalities && raceData.modalities.length) {
                raceData.modalities.forEach(mod => {
                    const id = 'mod-' + mod.replace(/\s+/g, '-').replace(/[^a-zA-Z0-9-_]/g, '');
                    const el = document.getElementById(id);
                    if (el) el.checked = true;
                });
            }

            document.getElementById('categories-list').style.display = raceData.useCategories ? 'grid' : 'none';
            document.getElementById('modalities-list').style.display = raceData.useModalities ? 'grid' : 'none';
            document.getElementById('categories-controls').style.display = raceData.useCategories ? 'flex' : 'none';
            document.getElementById('modalities-controls').style.display = raceData.useModalities ? 'flex' : 'none';

        } else {
            if (raceModalTitle) raceModalTitle.textContent = 'Adicionar Nova Prova';
            if (raceNameInput) raceNameInput.value = '';
            if (raceDateInput) raceDateInput.value = '';
            if (racePriceInput) racePriceInput.value = '';
            if (raceDescriptionInput) raceDescriptionInput.value = '';
            if (raceImageUrlInput) raceImageUrlInput.value = '';
            if (resultsLinkInput) resultsLinkInput.value = '';
            if (raceRegulationInput) raceRegulationInput.value = '';
            if (deleteRaceBtn) deleteRaceBtn.style.display = 'none';

            document.getElementById('use-categories').checked = true;
            document.getElementById('use-modalities').checked = true;
            populateCategoriesList();
            populateModalitiesList();
            document.getElementById('categories-list').style.display = 'grid';
            document.getElementById('modalities-list').style.display = 'grid';
            document.getElementById('categories-controls').style.display = 'flex';
            document.getElementById('modalities-controls').style.display = 'flex';
        }

        // atualizar preview ao abrir
        if (raceImageUrlInput && raceImageUrlInput.value) {
            updateImagePreview(raceImageUrlInput.value);
        } else {
            updateImagePreview('');
        }

        raceModal.style.display = 'block';
    }

    function saveRace() {
        if (isSavingRace) return;
        isSavingRace = true;
        const spinner = document.getElementById('race-spinner');
        const saveBtn = document.getElementById('save-race-btn');
        if (saveBtn) saveBtn.disabled = true;
        if (spinner) spinner.style.display = 'block';

        const raceNameInput = document.getElementById('race-name');
        const raceDateInput = document.getElementById('race-date');
        const racePriceInput = document.getElementById('race-price');
        const raceDescriptionInput = document.getElementById('race-description');
        const raceImageUrlInput = document.getElementById('race-image-url');
        const resultsLinkInput = document.getElementById('results-link');
        const raceRegulationInput = document.getElementById('race-regulation');

        const raceName = raceNameInput.value.trim();
        const raceDate = raceDateInput.value;
        const racePrice = racePriceInput.value.trim();
        const raceDescription = raceDescriptionInput.value.trim();

        let imageUrl = raceImageUrlInput.value.trim();
        imageUrl = normalizeGoogleDriveImage(imageUrl);

        const resultsLink = resultsLinkInput.value.trim();
        const regulationText = raceRegulationInput.value.trim();

        if (!raceName) { alert("O nome da prova é obrigatório."); finalizeRaceSave(); return; }
        if (!raceDate) { alert("A data da prova é obrigatória."); finalizeRaceSave(); return; }
        if (!racePrice || isNaN(Number(racePrice))) { alert("Informe um valor de inscrição válido."); finalizeRaceSave(); return; }

        const raceData = {
            id: editingRaceId || database.ref().child(PATH_RACES).push().key,
            name: raceName,
            date: raceDate,
            price: Number(racePrice),
            description: raceDescription,
            imageUrl: imageUrl,
            resultsLink: resultsLink || "",
            status: "open",
            useCategories: document.getElementById('use-categories').checked,
            useModalities: document.getElementById('use-modalities').checked,
            categories: [],
            modalities: [],
            regulation: regulationText || ''
        };

        if (raceData.useCategories) {
            document.querySelectorAll('#categories-list input:checked').forEach(item => { raceData.categories.push(item.value); });
        }
        if (raceData.useModalities) {
            document.querySelectorAll('#modalities-list input:checked').forEach(item => { raceData.modalities.push(item.value); });
        }

        saveRaceToFirebase(raceData)
            .then(() => {
                editingRaceId = null;
                alert('Prova salva com sucesso!');
                const raceModal = document.getElementById('race-modal');
                if (raceModal) raceModal.style.display = "none";
                loadRaces();
            })
            .catch(error => {
                console.error('Erro ao salvar prova:', error);
                alert('Erro ao salvar prova. Tente novamente.');
            })
            .finally(() => finalizeRaceSave());
    }

    function finalizeRaceSave() {
        isSavingRace = false;
        const spinner = document.getElementById('race-spinner');
        const saveBtn = document.getElementById('save-race-btn');
        if (saveBtn) saveBtn.disabled = false;
        if (spinner) spinner.style.display = 'none';
    }

    function deleteRace(raceId = null) {
        if (!raceId) {
            if (editingRaceId) raceId = editingRaceId;
            else return;
        }
        if (!confirm('Deseja realmente excluir esta prova?')) return;
        deleteRaceFromFirebase(raceId)
            .then(() => {
                const raceModal = document.getElementById('race-modal');
                if (raceModal) raceModal.style.display = 'none';
                loadRaces();
                alert('Prova excluída com sucesso!');
            })
            .catch(error => {
                console.error('Erro ao excluir prova:', error);
                alert('Erro ao excluir prova. Tente novamente.');
            });
    }

    function deleteRider(registrationId = null) {
        if (!registrationId) {
            if (currentRiderId) registrationId = currentRiderId;
            else return;
        }
        if (!confirm('Deseja realmente excluir esta inscrição?')) return;
        deleteRegistrationFromFirebase(registrationId)
            .then(() => {
                alert('Inscrição excluída com sucesso!');
                
                // Recarregar start list se estiver aberto
                const startlistModal = document.getElementById('startlist-modal');
                if (startlistModal && startlistModal.style.display === 'block') {
                    database.ref(`${PATH_RACES}`).once('value')
                        .then(snapshot => {
                            const races = snapshot.val() || {};
                            // Encontrar a prova atual para recarregar
                            database.ref(`${PATH_REGISTRATIONS}/${registrationId}/raceId`).once('value')
                                .then(raceIdSnapshot => {
                                    const raceId = raceIdSnapshot.val();
                                    if (raceId && races[raceId]) {
                                        loadStartListData(raceId, races[raceId]);
                                    }
                                });
                        });
                }
            })
            .catch(error => {
                console.error('Erro ao excluir inscrição:', error);
                alert('Erro ao excluir inscrição.');
            });
    }

    // ---------- STATUS FUNCTIONS ----------
    function toggleRaceStatus(raceId, currentStatus) {
        const newStatus = currentStatus === 'open' ? 'closed' : 'open';
        if (confirm(newStatus === 'open' ? 'Deseja abrir as inscrições?' : 'Deseja encerrar as inscrições?')) {
            database.ref(`${PATH_RACES}/${raceId}/status`).set(newStatus)
                .then(() => {
                    loadRaces();
                    alert('Status atualizado!');
                })
                .catch(error => {
                    console.error('Erro ao atualizar status:', error);
                    alert('Erro ao atualizar status.');
                });
        }
    }

    function finishRace(raceId) {
        if (confirm('Deseja realmente finalizar esta prova? Esta ação não pode ser desfeita.')) {
            database.ref(`${PATH_RACES}/${raceId}/status`).set('finished')
                .then(() => {
                    // ensure finished timestamp maybe
                    database.ref(`${PATH_RACES}/${raceId}/finishedAt`).set(Date.now()).catch(()=>{});
                    loadRaces();
                    alert('Prova finalizada com sucesso!');
                })
                .catch(error => {
                    console.error('Erro ao finalizar prova:', error);
                    alert('Erro ao finalizar prova.');
                });
        }
    }

    function activateRace(raceId) {
        if (confirm('Deseja reativar esta prova?')) {
            database.ref(`${PATH_RACES}/${raceId}/status`).set('open')
                .then(() => {
                    loadRaces();
                    alert('Prova reativada!');
                })
                .catch(error => {
                    console.error('Erro ao reativar prova:', error);
                    alert('Erro ao reativar prova.');
                });
        }
    }

    // ---------- Misc (details/regulation, riders) ----------
    function openDetailsModal(raceId, race) {
        const detailsModalTitle = document.getElementById('details-modal-title');
        const detailsContent = document.getElementById('details-content');
        const detailsModal = document.getElementById('details-modal');
        if (detailsModalTitle) detailsModalTitle.textContent = `Detalhes - ${race.name}`;
        if (detailsContent) {
            detailsContent.innerHTML = `<div class="race-info"><p><strong>Data:</strong> ${formatDate(race.date)}</p>
                                        <p><strong>Valor:</strong> R$${Number(race.price).toFixed(2)}</p>
                                        ${race.description ? `<p><strong>Descrição:</strong> ${race.description}</p>` : ''}</div>
                                        <p></p>`;
        }
        if (detailsModal) detailsModal.style.display = 'block';
    }

    function openRegulationModal(raceId, race) {
        const regulationModalTitle = document.getElementById('regulation-modal-title');
        const regulationContent = document.getElementById('regulation-content');
        const regulationModal = document.getElementById('regulation-modal');
        if (regulationModalTitle) regulationModalTitle.textContent = `Regulamento - ${race.name}`;
        if (regulationContent) regulationContent.innerHTML = `<div style="white-space:pre-wrap">${race.regulation || '<i>Regulamento não cadastrado.</i>'}</div>`;
        if (regulationModal) regulationModal.style.display = 'block';
    }

    // ---------- Initialization ----------
    function initApp() {
        $('#phone').mask('(00) 00000-0000');
        $('#birth-date').mask('00-00-0000');
        $('#edit-phone').mask('(00) 00000-0000');
        $('#edit-birth-date').mask('00-00-0000');

        populateCategoriesList();
        populateModalitiesList();

        const raceDateInput = document.getElementById('race-date');
        if (raceDateInput) {
            const today = new Date().toISOString().split('T')[0];
            raceDateInput.min = today;
        }

        document.querySelectorAll('.nav-tab').forEach(tab => tab.addEventListener('click', () => {
    document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
    tab.classList.add('active');
    currentTab = tab.dataset.tab;
    console.log('Tab clicada:', currentTab);
    
    // MOSTRAR/ESCONDER AS ABAS CORRETAMENTE
    document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.remove('active');
    });
    document.getElementById(currentTab).classList.add('active');
    
    console.log('Aba ativada:', document.getElementById(currentTab));
    
    loadRaces();
}));

        const useCategoriesCheckbox = document.getElementById('use-categories');
        const useModalitiesCheckbox = document.getElementById('use-modalities');
        if (useCategoriesCheckbox) useCategoriesCheckbox.addEventListener('change', function(){ const categoriesList = document.getElementById('categories-list'); const controls = document.getElementById('categories-controls'); if (categoriesList) categoriesList.style.display = this.checked ? 'grid' : 'none'; if (controls) controls.style.display = this.checked ? 'flex' : 'none'; });
        if (useModalitiesCheckbox) useModalitiesCheckbox.addEventListener('change', function(){ const modalitiesList = document.getElementById('modalities-list'); const controls = document.getElementById('modalities-controls'); if (modalitiesList) modalitiesList.style.display = this.checked ? 'grid' : 'none'; if (controls) controls.style.display = this.checked ? 'flex' : 'none'; });

        const loginBtnElement = document.getElementById('login-btn');
        const confirmLoginBtn = document.getElementById('confirm-login-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const addRaceBtn = document.getElementById('add-race-btn');
        const saveRaceBtn = document.getElementById('save-race-btn');
        const deleteRaceBtn = document.getElementById('delete-race-btn');
        const confirmRegisterBtn = document.getElementById('confirm-register-btn');
        const saveRiderBtn = document.getElementById('save-rider-btn');

        if (loginBtnElement) loginBtnElement.addEventListener('click', openLoginModal);
        if (confirmLoginBtn) confirmLoginBtn.addEventListener('click', loginAdmin);
        if (logoutBtn) logoutBtn.addEventListener('click', logoutAdmin);
        if (addRaceBtn) addRaceBtn.addEventListener('click', () => openRaceModal());
        if (saveRaceBtn) saveRaceBtn.addEventListener('click', saveRace);
        if (deleteRaceBtn) deleteRaceBtn.addEventListener('click', () => deleteRace());
        if (confirmRegisterBtn) confirmRegisterBtn.addEventListener('click', confirmRegistration);
        if (saveRiderBtn) saveRiderBtn.addEventListener('click', saveRiderChanges);

        // image preview
        const raceImageUrlInput = document.getElementById('race-image-url');
        if (raceImageUrlInput) raceImageUrlInput.addEventListener('input', function() { updateImagePreview(this.value); });

        // close buttons
        document.querySelectorAll('.close').forEach(closeBtn => {
            closeBtn.addEventListener('click', function() {
                const modal = this.closest('.modal');
                if (modal) modal.style.display = 'none';
            });
        });

        window.addEventListener('click', function(event) {
            if (event.target.classList && event.target.classList.contains('modal')) {
                event.target.style.display = 'none';
            }
        });

        // category/modal controls
        document.getElementById('cat-checkall').addEventListener('click', () => document.querySelectorAll('#categories-list input[type=checkbox]').forEach(c=>c.checked=true));
        document.getElementById('cat-uncheckall').addEventListener('click', () => document.querySelectorAll('#categories-list input[type=checkbox]').forEach(c=>c.checked=false));
        document.getElementById('mod-checkall').addEventListener('click', () => document.querySelectorAll('#modalities-list input[type=checkbox]').forEach(c=>c.checked=true));
        document.getElementById('mod-uncheckall').addEventListener('click', () => document.querySelectorAll('#modalities-list input[type=checkbox]').forEach(c=>c.checked=false));

        loadRaces();
    }

    document.addEventListener('DOMContentLoaded', initApp);
</script>
</body>
</html>
