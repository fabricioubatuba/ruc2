<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ranking Ubatuba de Ciclismo - R.U.C.</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.mask/1.14.16/jquery.mask.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        
        header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #333;
        }
        
        h1 {
            color: #2c3e50;
            margin-bottom: 5px;
        }
        
        .subtitle {
            color: #7f8c8d;
            font-size: 1.2em;
            margin-top: 0;
        }
        
        .race-card {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .race-title {
            color: #2c3e50;
            margin-top: 0;
        }
        
        .race-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
        }
        
        .race-date, .race-price {
            font-weight: bold;
        }
        
        .race-status {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 0.9em;
        }
        
        .status-open {
            background-color: #4CAF50;
            color: white;
        }
        
        .status-closed {
            background-color: #F44336;
            color: white;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            color: white;
            font-weight: bold;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
        }
        
        .btn-primary {
            background-color: #2196F3;
        }
        
        .btn-success {
            background-color: #4CAF50;
        }
        
        .btn-danger {
            background-color: #F44336;
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 1;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
        }
        
        .modal-content {
            background-color: #fefefe;
            margin: 10% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 90%;
            max-width: 600px;
            border-radius: 5px;
        }
        
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        
        .form-group input, .form-group select {
            width: 100%;
            padding: 8px;
            box-sizing: border-box;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        
        .admin-panel {
            margin-top: 30px;
            padding: 20px;
            background-color: #e9e9e9;
            border-radius: 5px;
            display: none;
        }
        
        .login-container {
            text-align: center;
            margin: 20px 0;
        }
        
        .login-btn {
            background-color: #4CAF50;
        }
        
        .logout-btn {
            background-color: #F44336;
        }
        
        .loading-spinner {
            display: none;
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-radius: 50%;
            border-top: 4px solid #3498db;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        
        .payment-info {
            background-color: #e8f5e9;
            padding: 15px;
            border-radius: 5px;
            margin-top: 20px;
            display: none;
        }
        
        .payment-info h3 {
            margin-top: 0;
            color: #2e7d32;
        }
        
        .pix-key {
            font-family: monospace;
            background-color: #fff;
            padding: 10px;
            border-radius: 4px;
            word-break: break-all;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Responsividade */
        @media (max-width: 768px) {
            .race-info {
                flex-direction: column;
            }
            
            .race-date, .race-price {
                margin-bottom: 10px;
            }
        }
    </style>
</head>
<body>
    <header>
        <h1>Ranking Ubatuba de Ciclismo - R.U.C.</h1>
        <p class="subtitle">Inscreva-se nas próximas provas e desafie seus limites!</p>
    </header>
    
    <div id="races-container">
        <!-- Provas serão carregadas dinamicamente -->
        <div class="loading-spinner" id="races-spinner"></div>
    </div>
    
    <div class="login-container" id="login-section">
        <button id="login-btn" class="btn login-btn">Login Admin</button>
    </div>
    
    <div class="admin-panel" id="admin-panel">
        <h2>Painel Administrativo</h2>
        <p>Você está logado como administrador.</p>
        <button id="add-race-btn" class="btn btn-primary">Adicionar Nova Prova</button>
        <button id="logout-btn" class="btn logout-btn">Logout</button>
    </div>
    
    <!-- Modal de inscrição -->
    <div id="register-modal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>Inscrição na Prova</h2>
            <p id="race-selected-name" style="font-weight: bold; margin-bottom: 20px;"></p>
            
            <div class="form-group">
                <label for="full-name">Nome Completo:</label>
                <input type="text" id="full-name" required>
            </div>
            
            <div class="form-group">
                <label for="birth-date">Data de Nascimento:</label>
                <input type="date" id="birth-date" required>
            </div>
            
            <div class="form-group">
                <label for="email">Email:</label>
                <input type="email" id="email" required>
            </div>
            
            <div class="form-group">
                <label for="phone">Telefone:</label>
                <input type="tel" id="phone" required>
            </div>
            
            <div class="form-group">
                <label for="category">Categoria:</label>
                <select id="category" required>
                    <option value="">Selecione sua categoria</option>
                    <option value="elite">Elite</option>
                    <option value="sub23">Sub-23</option>
                    <option value="master-a">Master A (30-39 anos)</option>
                    <option value="master-b">Master B (40-49 anos)</option>
                    <option value="master-c">Master C (50+ anos)</option>
                    <option value="feminino">Feminino</option>
                </select>
            </div>
            
            <div class="loading-spinner" id="register-spinner"></div>
            <button id="confirm-register-btn" class="btn btn-success">Gerar Pagamento</button>
            
            <div id="payment-info" class="payment-info">
                <h3>Pagamento via PIX</h3>
                <p>Por favor, realize o pagamento para confirmar sua inscrição:</p>
                <p><strong>Valor:</strong> R$<span id="payment-value">0</span>,00</p>
                <p><strong>Chave PIX:</strong></p>
                <div class="pix-key" id="pix-key">fa54ce23-7e5a-40c3-84bd-019b7e7d8f22</div>
                <p><strong>Beneficiário:</strong> Ranking Ubatuba de Ciclismo</p>
                <p>Após o pagamento, sua inscrição será confirmada automaticamente.</p>
                <p>Em caso de dúvidas, entre em contato: (12) 99747-3756</p>
            </div>
        </div>
    </div>
    
    <!-- Modal de login -->
    <div id="login-modal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>Login Administrativo</h2>
            <div class="form-group">
                <label for="admin-email">Email:</label>
                <input type="email" id="admin-email" required>
            </div>
            <div class="form-group">
                <label for="admin-password">Senha:</label>
                <input type="password" id="admin-password" required>
            </div>
            <button id="confirm-login-btn" class="btn btn-success">Login</button>
            <p id="login-error" style="color: red; display: none;">Email ou senha incorretos.</p>
        </div>
    </div>
    
    <!-- Modal de adição de prova -->
    <div id="add-race-modal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>Adicionar Nova Prova</h2>
            
            <div class="form-group">
                <label for="race-name">Nome da Prova:</label>
                <input type="text" id="race-name" required>
            </div>
            
            <div class="form-group">
                <label for="race-date">Data da Prova:</label>
                <input type="date" id="race-date" required>
            </div>
            
            <div class="form-group">
                <label for="race-price">Valor da Inscrição (R$):</label>
                <input type="number" id="race-price" min="0" step="0.01" required>
            </div>
            
            <div class="form-group">
                <label for="race-description">Descrição (opcional):</label>
                <textarea id="race-description" rows="3" style="width: 100%; padding: 8px; box-sizing: border-box; border: 1px solid #ddd; border-radius: 4px;"></textarea>
            </div>
            
            <div class="loading-spinner" id="add-race-spinner"></div>
            <button id="save-race-btn" class="btn btn-success">Salvar Prova</button>
        </div>
    </div>
    
    <script>
        // Configuração do Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyClzqFmEL9y_ugHnC7V4DnFiANX6RLDYzc",
            authDomain: "teste-c702e.firebaseapp.com",
            databaseURL: "https://teste-c702e-default-rtdb.firebaseio.com",
            projectId: "teste-c702e",
            storageBucket: "teste-c702e.appspot.com",
            messagingSenderId: "478905955045",
            appId: "1:478905955045:web:3ba118957038593fe85a0c"
        };
        
        // Inicializar Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const auth = firebase.auth();
        
        // Variáveis globais
        let isAdmin = false;
        let currentRaceId = null;
        
        // Elementos do DOM
        const racesContainer = document.getElementById('races-container');
        const loginBtn = document.getElementById('login-btn');
        const adminPanel = document.getElementById('admin-panel');
        const logoutBtn = document.getElementById('logout-btn');
        const addRaceBtn = document.getElementById('add-race-btn');
        const registerModal = document.getElementById('register-modal');
        const loginModal = document.getElementById('login-modal');
        const addRaceModal = document.getElementById('add-race-modal');
        const closeButtons = document.getElementsByClassName('close');
        const confirmRegisterBtn = document.getElementById('confirm-register-btn');
        const fullNameInput = document.getElementById('full-name');
        const birthDateInput = document.getElementById('birth-date');
        const emailInput = document.getElementById('email');
        const phoneInput = document.getElementById('phone');
        const categoryInput = document.getElementById('category');
        const paymentInfo = document.getElementById('payment-info');
        const paymentValue = document.getElementById('payment-value');
        const confirmLoginBtn = document.getElementById('confirm-login-btn');
        const adminEmailInput = document.getElementById('admin-email');
        const adminPasswordInput = document.getElementById('admin-password');
        const loginError = document.getElementById('login-error');
        const raceNameInput = document.getElementById('race-name');
        const raceDateInput = document.getElementById('race-date');
        const racePriceInput = document.getElementById('race-price');
        const raceDescriptionInput = document.getElementById('race-description');
        const saveRaceBtn = document.getElementById('save-race-btn');
        const raceSelectedName = document.getElementById('race-selected-name');
        const registerSpinner = document.getElementById('register-spinner');
        const addRaceSpinner = document.getElementById('add-race-spinner');
        const racesSpinner = document.getElementById('races-spinner');
        
        // Inicializar a aplicação
        function initApp() {
            // Configurar máscara de telefone
            $('#phone').mask('(00) 00000-0000');
            
            // Verificar estado de autenticação
            auth.onAuthStateChanged(user => {
                if (user && user.email === "bioranss@gmail.com") {
                    isAdmin = true;
                    adminPanel.style.display = 'block';
                    loginBtn.textContent = 'Admin Logado';
                    loginBtn.disabled = true;
                } else {
                    isAdmin = false;
                    adminPanel.style.display = 'none';
                    loginBtn.textContent = 'Login Admin';
                    loginBtn.disabled = false;
                }
            });
            
            // Carregar provas
            loadRaces();
            
            // Event listeners
            loginBtn.addEventListener('click', openLoginModal);
            confirmLoginBtn.addEventListener('click', loginAdmin);
            logoutBtn.addEventListener('click', logoutAdmin);
            addRaceBtn.addEventListener('click', openAddRaceModal);
            saveRaceBtn.addEventListener('click', saveRace);
            confirmRegisterBtn.addEventListener('click', confirmRegistration);
            
            // Fechar modais ao clicar no X
            for (let i = 0; i < closeButtons.length; i++) {
                closeButtons[i].addEventListener('click', function() {
                    this.closest('.modal').style.display = 'none';
                });
            }
            
            // Fechar modais ao clicar fora
            window.addEventListener('click', function(event) {
                if (event.target.className === 'modal') {
                    event.target.style.display = 'none';
                }
            });
        }
        
        // Carregar provas do Firebase
        function loadRaces() {
            racesSpinner.style.display = 'block';
            racesContainer.innerHTML = '';
            
            database.ref('races').on('value', snapshot => {
                racesSpinner.style.display = 'none';
                
                if (!snapshot.exists()) {
                    racesContainer.innerHTML = '<p>Nenhuma prova disponível no momento.</p>';
                    return;
                }
                
                const races = snapshot.val();
                let hasOpenRaces = false;
                
                for (const raceId in races) {
                    const race = races[raceId];
                    const raceElement = createRaceElement(raceId, race);
                    racesContainer.appendChild(raceElement);
                    
                    if (race.status === 'open') {
                        hasOpenRaces = true;
                    }
                }
                
                if (!hasOpenRaces) {
                    racesContainer.innerHTML += '<p style="text-align: center;">Não há provas com inscrições abertas no momento.</p>';
                }
            });
        }
        
        // Criar elemento HTML para uma prova
        function createRaceElement(raceId, race) {
            const raceElement = document.createElement('div');
            raceElement.className = 'race-card';
            
            const statusClass = race.status === 'open' ? 'status-open' : 'status-closed';
            const statusText = race.status === 'open' ? 'Inscrições Abertas' : 'Inscrições Encerradas';
            
            raceElement.innerHTML = `
                <h3 class="race-title">${race.name}</h3>
                <div class="race-info">
                    <span class="race-date">Data: ${formatDate(race.date)}</span>
                    <span class="race-price">Valor: R$${race.price.toFixed(2)}</span>
                    <span class="race-status ${statusClass}">${statusText}</span>
                </div>
                ${race.description ? `<p>${race.description}</p>` : ''}
            `;
            
            if (race.status === 'open') {
                const registerBtn = document.createElement('button');
                registerBtn.className = 'btn btn-primary';
                registerBtn.textContent = 'Fazer Inscrição';
                registerBtn.addEventListener('click', () => openRegisterModal(raceId, race));
                raceElement.appendChild(registerBtn);
            }
            
            if (isAdmin) {
                const adminActions = document.createElement('div');
                adminActions.style.marginTop = '15px';
                
                const toggleStatusBtn = document.createElement('button');
                toggleStatusBtn.className = 'btn ' + (race.status === 'open' ? 'btn-danger' : 'btn-success');
                toggleStatusBtn.textContent = race.status === 'open' ? 'Encerrar Inscrições' : 'Abrir Inscrições';
                toggleStatusBtn.style.marginRight = '10px';
                toggleStatusBtn.addEventListener('click', () => toggleRaceStatus(raceId, race.status));
                
                adminActions.appendChild(toggleStatusBtn);
                raceElement.appendChild(adminActions);
            }
            
            return raceElement;
        }
        
        // Formatar data para exibição
        function formatDate(dateString) {
            const options = { day: '2-digit', month: '2-digit', year: 'numeric' };
            return new Date(dateString).toLocaleDateString('pt-BR', options);
        }
        
        // Abrir modal de inscrição
        function openRegisterModal(raceId, race) {
            currentRaceId = raceId;
            raceSelectedName.textContent = race.name;
            fullNameInput.value = '';
            birthDateInput.value = '';
            emailInput.value = '';
            phoneInput.value = '';
            categoryInput.value = '';
            paymentInfo.style.display = 'none';
            registerModal.style.display = 'block';
        }
        
        // Confirmar inscrição
        function confirmRegistration() {
            const name = fullNameInput.value.trim();
            const birthDate = birthDateInput.value;
            const email = emailInput.value.trim();
            const phone = phoneInput.value.trim();
            const category = categoryInput.value;
            
            if (!name || !birthDate || !email || !phone || !category) {
                alert('Por favor, preencha todos os campos obrigatórios.');
                return;
            }
            
            const phoneDigits = phone.replace(/\D/g, '');
            if (phoneDigits.length < 11) {
                alert('Por favor, insira um telefone válido com DDD.');
                return;
            }
            
            // Mostrar spinner e desabilitar botão
            registerSpinner.style.display = 'block';
            confirmRegisterBtn.disabled = true;
            
            // Obter dados da prova para pegar o valor
            database.ref(`races/${currentRaceId}`).once('value')
                .then(snapshot => {
                    const race = snapshot.val();
                    
                    // Gerar ID único para a inscrição
                    const registrationId = database.ref().child('registrations').push().key;
                    
                    // Dados da inscrição
                    const registrationData = {
                        raceId: currentRaceId,
                        raceName: race.name,
                        name,
                        birthDate,
                        email,
                        phone,
                        category,
                        status: 'pending', // pending, paid, cancelled
                        registrationDate: new Date().toISOString(),
                        paymentMethod: 'pix'
                    };
                    
                    // Salvar inscrição no Firebase
                    return database.ref(`registrations/${registrationId}`).set(registrationData)
                        .then(() => {
                            // Mostrar informações de pagamento
                            paymentValue.textContent = race.price.toFixed(2);
                            paymentInfo.style.display = 'block';
                            confirmRegisterBtn.textContent = 'Inscrição Gerada';
                            confirmRegisterBtn.disabled = true;
                            
                            // Rolar para as informações de pagamento
                            paymentInfo.scrollIntoView({ behavior: 'smooth' });
                            
                            // Opcional: Gerar QR Code PIX aqui se necessário
                        });
                })
                .catch(error => {
                    console.error('Erro na inscrição:', error);
                    alert('Ocorreu um erro ao processar sua inscrição. Por favor, tente novamente.');
                })
                .finally(() => {
                    registerSpinner.style.display = 'none';
                });
        }
        
        // Abrir modal de login
        function openLoginModal() {
            loginModal.style.display = 'block';
            loginError.style.display = 'none';
            adminEmailInput.value = '';
            adminPasswordInput.value = '';
        }
        
        // Login do administrador
        function loginAdmin() {
            const email = adminEmailInput.value.trim();
            const password = adminPasswordInput.value.trim();
            
            if (!email || !password) {
                loginError.style.display = 'block';
                return;
            }
            
            auth.signInWithEmailAndPassword(email, password)
                .then(userCredential => {
                    if (userCredential.user.email === "bioranss@gmail.com") {
                        loginModal.style.display = 'none';
                        isAdmin = true;
                        adminPanel.style.display = 'block';
                        loginBtn.textContent = 'Admin Logado';
                        loginBtn.disabled = true;
                        loadRaces(); // Recarregar provas para mostrar ações admin
                    } else {
                        throw new Error('Acesso não autorizado');
                    }
                })
                .catch(error => {
                    console.error('Erro no login:', error);
                    loginError.style.display = 'block';
                });
        }
        
        // Logout do administrador
        function logoutAdmin() {
            auth.signOut()
                .then(() => {
                    isAdmin = false;
                    adminPanel.style.display = 'none';
                    loginBtn.textContent = 'Login Admin';
                    loginBtn.disabled = false;
                    loadRaces(); // Recarregar provas para remover ações admin
                })
                .catch(error => {
                    console.error('Erro no logout:', error);
                });
        }
        
        // Abrir modal para adicionar nova prova
        function openAddRaceModal() {
            raceNameInput.value = '';
            raceDateInput.value = '';
            racePriceInput.value = '';
            raceDescriptionInput.value = '';
            addRaceModal.style.display = 'block';
        }
        
        // Salvar nova prova
        function saveRace() {
            const name = raceNameInput.value.trim();
            const date = raceDateInput.value;
            const price = parseFloat(racePriceInput.value);
            const description = raceDescriptionInput.value.trim();
            
            if (!name || !date || isNaN(price) || price <= 0) {
                alert('Por favor, preencha todos os campos obrigatórios com valores válidos.');
                return;
            }
            
            // Mostrar spinner e desabilitar botão
            addRaceSpinner.style.display = 'block';
            saveRaceBtn.disabled = true;
            
            const raceData = {
                name,
                date,
                price,
                description: description || null,
                status: 'open', // open, closed
                createdAt: new Date().toISOString()
            };
            
            // Salvar prova no Firebase
            database.ref('races').push(raceData)
                .then(() => {
                    addRaceModal.style.display = 'none';
                    alert('Prova cadastrada com sucesso!');
                })
                .catch(error => {
                    console.error('Erro ao salvar prova:', error);
                    alert('Ocorreu um erro ao salvar a prova. Por favor, tente novamente.');
                })
                .finally(() => {
                    addRaceSpinner.style.display = 'none';
                    saveRaceBtn.disabled = false;
                });
        }
        
        // Alternar status da prova (aberto/fechado)
        function toggleRaceStatus(raceId, currentStatus) {
            const newStatus = currentStatus === 'open' ? 'closed' : 'open';
            const confirmMsg = newStatus === 'open' 
                ? 'Deseja realmente abrir as inscrições para esta prova?' 
                : 'Deseja realmente encerrar as inscrições para esta prova?';
            
            if (confirm(confirmMsg)) {
                database.ref(`races/${raceId}/status`).set(newStatus)
                    .then(() => {
                        alert(`Inscrições ${newStatus === 'open' ? 'abertas' : 'encerradas'} com sucesso!`);
                    })
                    .catch(error => {
                        console.error('Erro ao atualizar status:', error);
                        alert('Ocorreu um erro ao atualizar o status da prova.');
                    });
            }
        }
        
        // Iniciar aplicação
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>